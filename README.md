# avito-challenge-go описание работы сервиса
Реализован сервис обрабатывающий http или grpc запросы (swagger можно посмотреть в папке api). Обработка производится через grpc gateway сгенерированный с помощью `protoc`. Все суммы в базе данных переводятся в рубли и храянятся в копейках (была выбрана такая реализация для наглядности). На примере telegram бота можно посмотреть как происходит работа с множественными валютами - запрашивается курс валют с сервиса ЦБ РФ с точнотью до двух знаков после запятой и при каждом запросе сумма переводится из той валюты с которой сейчас работает пользователь - в копейки и передается далее на сервис.

## Дополнительный функционал
- Добавлен линтер (`make lint` для запуска)
- Добавлены тесты с использованием [gomock](https://github.com/golang/mock) (`make test`)
- Реализована работа с множеством валют (для примера представлены только RUB, EUR, USD, CNY)
- Реализован простой телеграм бот, который отправляет заданные http запросы на сервер (для наглядности)
<img src = "./img/telegram.png?raw=true" width = "30%" height = "30%" alt = "jaeger" align = center />
- Реализован сбор логов <br/>
Для запуска сбора логов можно запустить сервер при помощи `make logs`  <br/>
Для просмотра UI интерфейса Graylog можно перейти по адресу http://127.0.0.1:7555/ (логин/пароль - admin/admin)
<img src = "./img/graylog.png?raw=true" width = "60%" height = "60%" alt = "graylog" align = center />
- Реализован сбор трейсов <br/>
Запустить сбор трейсов можно с помощью команды `make tracing` <br/>
Графический интерфейс Jaeger находится по адресу: http://127.0.0.1:16686/
<img src = "./img/jaeger.png?raw=true" width = "60%" height = "60%" alt = "jaeger" align = center />

## Запуск сервиса
Для запуска сервисанужно сделать следующие шаги:
1. Создать докер образ на порту указанном в config.yaml (по умолчанию 5432) <br/>
`docker run --name avito-challenge -e POSTGRES_PASSWORD=postgres -p 5432:5432 -d postgres`
2. При помощи инструмента [goose](https://github.com/pressly/goose) провести миграции для инициализации базы данных <br/>
`go install github.com/pressly/goose/v3/cmd/goose@latest` <br/>
`goose -dir migrations postgres "host=localhost port=5432 user=postgres password=postgres sslmode=disable" up`
3. Запустить сервер при помощи команды `make run`

## Использования сервиса
### При помощи telegram бота
1. Введите в файл data/config.yaml в поле `token` - token вашего бота
2. При помощи команды `make run` запустите бота
3. Команды для тестирования: <br/>
- `/credit amount` -- зачисляем сумму на счет пользователя -- amount - сумма в копейках / центах / ... в зависимости от выбранной валюты (по умолчанию рубли) <br/>
- `/reserve order_id service_id amount` -- резервируем сумму по данным со счета пользователя -- order_id - id заказа, service_id - id сервиса, amount - сумма <br/>
- `/cancel order_id service_id amount` -- отменяем резервирование средств пользователя по данным (деньги возвращаются на счет пользователя) -- order_id - id заказа, service_id - id сервиса, amount - сумма <br/>
- `/writeoff order_id service_id amount` -- подтверждаем резервирование средств по данным пользователя -- order_id - id заказа, service_id - id сервиса, amount - сумма <br/>
- `/get_balance` -- получить текущий баланс пользователя <br/>
- `/get_report` -- получаем отчет по всем тратам и пополнениям пользователя <br/>
- `/change_currency currency` -- меняем валюту пользователя на заданную -- currency - (rub, eur, usd, cny) <br/>
- `/get_currency` -- получаем ту валюту, с которой сейчас мы работаем <br/>
Везде в качестве id пользователя берется telegram id отправителя сообщения<br/>
Все числа записываются через пробел, никакой проверки данных нет (бот сделан просто для наглядности работы с разными функциями такими как работа с разными ваютами и простоты тестирования), и при неверных данных бот падает :)

### При помощи postman
Можно проверить работоспособность при помощи grpc запросов (localhost:8081) или http запросов (localhost:8080)
#### grpc запросы
Все возможные функции postman уже сам подцепит благодаря reflection, достаточно только выбирать методы и вводить данные или генерировать их при помощи postman'a<br/>
<img src = "./img/grpc_req.png?raw=true" width = "60%" height = "60%" alt = "grpc" align = center />
#### http запросы
- /api/credit - зачисляем сумму на счет пользователя
- /api/cancelreserve - отменяем резервирование средств пользователя по данным (деньги возвращаются на счет пользователя)
- /api/writeoff - подтверждаем резервирование средств по данным пользователя
- /api/getbalance - получить текущий баланс пользователя
- /api/getreport - получаем отчет по всем тратам и пополнениям пользователя <br/>
<img src = "./img/http_req.png?raw=true" width = "60%" height = "60%" alt = "http" align = center />

## Что можно добавить?
- graceful shoutdown бота и сервиса
- улучшить бота, сделать красивый интерфейс
- добавить построитель отчетов в различных срезах
- добавить возможночть передавать деньги от одного пользователя к другому
- добавить поддержку большего числа валют
- добавить очередь сообщений при чтении запросов
- добавить кеш на работу с валютой и недавние запросы по пользователям

## Issues
- иногда не с первого раза получается запустить сервис получения курса валют
